<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rnb.newbase.security.persistent.mapper.SystemResourceMapper">

    <sql id="conditionColumn">
        <if test="null!=id">
            and `id` = #{id}
        </if>
        <if test="null!=parentId">
            and `parent_id` = #{parentId}
        </if>
    </sql>

    <sql id="setColumn">
        <if test="null!=code">
            `code` = #{code},
        </if>
        <if test="null!=name">
            `name` = #{name},
        </if>
        <if test="null!=weight">
            `weight` = #{weight},
        </if>
        <if test="null!=type">
            `type` = #{type, typeHandler=com.rnb.newbase.security.persistent.handler.SystemResourceTypeEnumTypeHandler},
        </if>
        <if test="null!=url">
            `url` = #{url},
        </if>
        <if test="null!=parent_id">
            `parent_id` = #{parentId},
        </if>
        <if test="null!=has_child">
            `has_child` = #{hasChild},
        </if>
    </sql>

    <sql id="baseColumn">
        `id`,`code`,`name`,`weight`,`type`,`url`,`parent_id`,`has_child`,`create_time`,`modify_time`
    </sql>

    <sql id="tableName">`system_resource`</sql>

    <resultMap id="resultMap"  type="com.rnb.newbase.security.persistent.entity.SystemResource">
        <id column="id" property="id" />
        <result column="code" property="code" />
        <result column="name" property="name"/>
        <result column="weight" property="weight" />
        <result column="type" property="type" typeHandler="com.rnb.newbase.security.persistent.handler.SystemResourceTypeEnumTypeHandler"/>
        <result column="url" property="url" />
        <result column="parent_id" property="parentId" />
        <result column="has_child" property="hasChild" />
        <result column="create_time" property="createTime" />
        <result column="modify_time" property="modifyTime" />
    </resultMap>

    <insert id="insert" parameterType="com.rnb.newbase.security.persistent.entity.SystemResource" useGeneratedKeys="true" keyProperty="id">
        insert into <include refid="tableName"/> (
        `code`
        ,`name`
        ,`weight`
        ,`type`
        ,`url`
        ,`parent_id`
        ,`create_time`
        ) values (
        #{code}
        ,#{name}
        ,#{weight}
        ,#{type, typeHandler=com.rnb.newbase.security.persistent.handler.SystemResourceTypeEnumTypeHandler}
        ,#{url}
        ,#{parentId}
        ,now()
        )
    </insert>

    <update id="update">
        update
        <include refid="tableName"/>
        <set>
            <include refid="setColumn"/>
        </set>
        where
        `id` = #{id}
    </update>

    <select id="queryById" resultMap="resultMap">
        select
        <include refid="baseColumn" />
        from
        <include refid="tableName"/>
        where
        `id` = #{id}
    </select>

    <select id="queryListByCondition" resultMap="resultMap">
        select
        <include refid="baseColumn" />
        from
        <include refid="tableName"/>
        <where>
            <include refid="conditionColumn"/>
        </where>
        order by
        `id`
    </select>

    <select id="findRoleResources" resultMap="resultMap">
        SELECT
        <include refid="baseColumn" />
        FROM
        <include refid="tableName"/> AS s
        WHERE
        s.`id` in (
        SELECT
        rs.`resource_id`
        FROM
        `system_role_resource` AS rs
        WHERE
        rs.`role_id` = #{roleId}
        )
    </select>

    <delete id="delete">
        DELETE FROM <include refid="tableName" />
        WHERE `id` = #{id}
    </delete>
</mapper>